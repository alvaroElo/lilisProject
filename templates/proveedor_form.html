{% extends 'base.html' %}
{% load static %}

{% block title %}{% if proveedor %}Editar{% else %}Nuevo{% endif %} Proveedor - Dulcería Lilis{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2 class="page-title">
            <i class="fas fa-{% if proveedor %}edit{% else %}plus-circle{% endif %}"></i>
            {% if proveedor %}Editar Proveedor{% else %}Nuevo Proveedor{% endif %}
        </h2>
        <p class="page-subtitle">Completa la información del proveedor</p>
    </div>
    <a href="{% url 'proveedores_list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver
    </a>
</div>

<form method="post" action="">
    {% csrf_token %}
    
    <!-- Información Básica -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-building"></i> Información Básica
            </h3>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="rut_nif" class="form-label">RUT/NIF *</label>
                <input 
                    type="text" 
                    id="rut_nif" 
                    name="rut_nif" 
                    class="form-control" 
                    value="{{ proveedor.rut_nif|default:'' }}"
                    placeholder="12.345.678-9"
                    data-tipo="rut"
                    required
                    {% if proveedor %}readonly{% endif %}
                >
                <small class="validation-help">Formato: 12.345.678-9 (se valida automáticamente)</small>
            </div>
            
            <div class="form-group">
                <label for="estado" class="form-label">Estado *</label>
                <select id="estado" name="estado" class="form-control" required>
                    <option value="ACTIVO" {% if not proveedor or proveedor.estado == 'ACTIVO' %}selected{% endif %}>Activo</option>
                    <option value="BLOQUEADO" {% if proveedor and proveedor.estado == 'BLOQUEADO' %}selected{% endif %}>Bloqueado</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="razon_social" class="form-label">Razón Social *</label>
                <input 
                    type="text" 
                    id="razon_social" 
                    name="razon_social" 
                    class="form-control" 
                    value="{{ proveedor.razon_social|default:'' }}"
                    placeholder="Distribuidora Ejemplo S.A."
                    required
                >
            </div>
            
            <div class="form-group">
                <label for="nombre_fantasia" class="form-label">Nombre Fantasía</label>
                <input 
                    type="text" 
                    id="nombre_fantasia" 
                    name="nombre_fantasia" 
                    class="form-control" 
                    value="{{ proveedor.nombre_fantasia|default:'' }}"
                    placeholder="Nombre comercial"
                >
            </div>
        </div>
    </div>
    
    <!-- Información de Contacto -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-address-book"></i> Información de Contacto
            </h3>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="email" class="form-label">Email *</label>
                <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    class="form-control" 
                    value="{{ proveedor.email|default:'' }}"
                    placeholder="contacto@proveedor.com"
                    data-tipo="email"
                    required
                >
                <small class="validation-help">Ejemplo: contacto@empresa.com</small>
            </div>
            
            <div class="form-group">
                <label for="telefono" class="form-label">Teléfono</label>
                <input 
                    type="tel" 
                    id="telefono" 
                    name="telefono" 
                    class="form-control" 
                    value="{{ proveedor.telefono|default:'' }}"
                    placeholder="+56 9 1234 5678"
                    data-tipo="telefono"
                >
                <small class="validation-help">Formato: +56912345678</small>
            </div>
            
            <div class="form-group">
                <label for="sitio_web" class="form-label">Sitio Web</label>
                <input 
                    type="url" 
                    id="sitio_web" 
                    name="sitio_web" 
                    class="form-control" 
                    value="{{ proveedor.sitio_web|default:'' }}"
                    placeholder="https://www.proveedor.com"
                >
            </div>
        </div>
        
        <div class="form-group">
            <label for="direccion" class="form-label">Dirección</label>
            <input 
                type="text" 
                id="direccion" 
                name="direccion" 
                class="form-control" 
                value="{{ proveedor.direccion|default:'' }}"
                placeholder="Calle Principal #123, Edificio ABC"
            >
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="ciudad" class="form-label">Ciudad</label>
                <input 
                    type="text" 
                    id="ciudad" 
                    name="ciudad" 
                    class="form-control" 
                    value="{{ proveedor.ciudad|default:'' }}"
                    placeholder="Santiago"
                >
            </div>
            
            <div class="form-group">
                <label for="pais" class="form-label">País *</label>
                <input 
                    type="text" 
                    id="pais" 
                    name="pais" 
                    class="form-control" 
                    value="{{ proveedor.pais|default:'Chile' }}"
                    required
                >
            </div>
        </div>
    </div>
    
    <!-- Contacto Principal -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-user-tie"></i> Contacto Principal
            </h3>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="contacto_principal_nombre" class="form-label">Nombre Completo</label>
                <input 
                    type="text" 
                    id="contacto_principal_nombre" 
                    name="contacto_principal_nombre" 
                    class="form-control" 
                    value="{{ proveedor.contacto_principal_nombre|default:'' }}"
                    placeholder="Juan Pérez"
                >
            </div>
            
            <div class="form-group">
                <label for="contacto_principal_email" class="form-label">Email del Contacto</label>
                <input 
                    type="email" 
                    id="contacto_principal_email" 
                    name="contacto_principal_email" 
                    class="form-control" 
                    value="{{ proveedor.contacto_principal_email|default:'' }}"
                    placeholder="juan.perez@proveedor.com"
                >
            </div>
            
            <div class="form-group">
                <label for="contacto_principal_telefono" class="form-label">Teléfono del Contacto</label>
                <input 
                    type="tel" 
                    id="contacto_principal_telefono" 
                    name="contacto_principal_telefono" 
                    class="form-control" 
                    value="{{ proveedor.contacto_principal_telefono|default:'' }}"
                    placeholder="+56 9 8765 4321"
                >
            </div>
        </div>
    </div>
    
    <!-- Condiciones Comerciales -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-hand-holding-usd"></i> Condiciones Comerciales
            </h3>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="condiciones_pago" class="form-label">Condiciones de Pago *</label>
                <select id="condiciones_pago" name="condiciones_pago" class="form-control" required>
                    <option value="">Seleccionar...</option>
                    <option value="CONTADO" {% if proveedor and proveedor.condiciones_pago == 'CONTADO' %}selected{% endif %}>Contado</option>
                    <option value="30_DIAS" {% if proveedor and proveedor.condiciones_pago == '30_DIAS' %}selected{% endif %}>30 días</option>
                    <option value="60_DIAS" {% if proveedor and proveedor.condiciones_pago == '60_DIAS' %}selected{% endif %}>60 días</option>
                    <option value="90_DIAS" {% if proveedor and proveedor.condiciones_pago == '90_DIAS' %}selected{% endif %}>90 días</option>
                    <option value="OTRO" {% if proveedor and proveedor.condiciones_pago == 'OTRO' %}selected{% endif %}>Otro</option>
                </select>
            </div>
            
            <div class="form-group {% if not proveedor or proveedor.condiciones_pago != 'OTRO' %}hidden{% endif %}" id="condiciones-detalle-group">
                <label for="condiciones_pago_detalle" class="form-label">Detalle Condiciones</label>
                <input 
                    type="text" 
                    id="condiciones_pago_detalle" 
                    name="condiciones_pago_detalle" 
                    class="form-control" 
                    value="{{ proveedor.condiciones_pago_detalle|default:'' }}"
                    placeholder="Especificar condiciones personalizadas"
                >
            </div>
            
            <div class="form-group">
                <label for="moneda" class="form-label">Moneda *</label>
                <select id="moneda" name="moneda" class="form-control" required>
                    <option value="CLP" {% if not proveedor or proveedor.moneda == 'CLP' %}selected{% endif %}>CLP - Peso Chileno</option>
                    <option value="USD" {% if proveedor and proveedor.moneda == 'USD' %}selected{% endif %}>USD - Dólar</option>
                    <option value="EUR" {% if proveedor and proveedor.moneda == 'EUR' %}selected{% endif %}>EUR - Euro</option>
                    <option value="ARS" {% if proveedor and proveedor.moneda == 'ARS' %}selected{% endif %}>ARS - Peso Argentino</option>
                    <option value="BRL" {% if proveedor and proveedor.moneda == 'BRL' %}selected{% endif %}>BRL - Real Brasileño</option>
                    <option value="PEN" {% if proveedor and proveedor.moneda == 'PEN' %}selected{% endif %}>PEN - Sol Peruano</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Observaciones -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-comment-alt"></i> Observaciones
            </h3>
        </div>
        <div class="form-group">
            <label for="observaciones" class="form-label">Notas Adicionales</label>
            <textarea 
                id="observaciones" 
                name="observaciones" 
                class="form-control" 
                rows="4"
                placeholder="Cualquier información adicional sobre el proveedor..."
            >{{ proveedor.observaciones|default:'' }}</textarea>
        </div>
    </div>
    
    <!-- Botones -->
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Guardar Proveedor
        </button>
        <a href="{% url 'proveedores_list' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
        {% if proveedor %}
        <button type="button" class="btn btn-danger" onclick="confirmarEliminacion()">
            <i class="fas fa-trash"></i> Eliminar
        </button>
        {% endif %}
    </div>
</form>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.page-title {
    font-size: 2rem;
    color: var(--color-text-focus);
    margin-bottom: 0.5rem;
}

.page-subtitle {
    color: var(--color-text);
    font-size: 1rem;
}

.form-help {
    display: block;
    font-size: 0.85rem;
    color: var(--color-text);
    margin-top: 0.25rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px var(--color-shadow);
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
}

input[readonly] {
    background-color: #f5f5f5;
    cursor: not-allowed;
}

.hidden {
    display: none !important;
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .form-actions .btn {
        width: 100%;
    }
}
</style>

<script>
// Mostrar/ocultar detalle de condiciones de pago
document.getElementById('condiciones_pago')?.addEventListener('change', function() {
    const detalleGroup = document.getElementById('condiciones-detalle-group');
    if (this.value === 'OTRO') {
        detalleGroup.classList.remove('hidden');
        document.getElementById('condiciones_pago_detalle').required = true;
    } else {
        detalleGroup.classList.add('hidden');
        document.getElementById('condiciones_pago_detalle').required = false;
    }
});

// Formatear RUT mientras se escribe (solo si no es readonly)
const rutInput = document.getElementById('rut_nif');
if (rutInput && !rutInput.readOnly) {
    rutInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^0-9kK]/g, '');
        if (value.length > 1) {
            value = value.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + value.slice(-1);
        }
        e.target.value = value;
    });
}

// Confirmar eliminación
function confirmarEliminacion() {
    if (confirm('¿Estás seguro de que deseas eliminar este proveedor? Esta acción no se puede deshacer.')) {
        // Aquí iría la lógica de eliminación
        alert('Funcionalidad de eliminación en desarrollo');
    }
}

// Validación personalizada del formulario
document.querySelector('form')?.addEventListener('submit', function(e) {
    const email = document.getElementById('email').value;
    const contactoEmail = document.getElementById('contacto_principal_email').value;
    
    // Validar que el email del contacto no sea igual al email principal si ambos están llenos
    if (contactoEmail && email === contactoEmail) {
        const confirmacion = confirm('El email del contacto es el mismo que el email principal. ¿Deseas continuar?');
        if (!confirmacion) {
            e.preventDefault();
        }
    }
});
</script>
{% endblock %}
