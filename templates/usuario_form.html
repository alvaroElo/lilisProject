{% extends 'base.html' %}
{% load static %}

{% block title %}{% if usuario %}Editar{% else %}Nuevo{% endif %} Usuario - Dulcería Lilis{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2 class="page-title">
            <i class="fas fa-user-{% if usuario %}edit{% else %}plus{% endif %}"></i> 
            {% if usuario %}Editar Usuario{% else %}Nuevo Usuario{% endif %}
        </h2>
        <p class="page-subtitle">Completa la información del usuario</p>
    </div>
    <a href="{% url 'usuarios_list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver
    </a>
</div>

<form method="post" action="" class="user-form">
    {% csrf_token %}
    
    <!-- Información Básica -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-id-card"></i> Información Básica
            </h3>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="username" class="form-label">Usuario *</label>
                <input 
                    type="text" 
                    id="username" 
                    name="username" 
                    class="form-control" 
                    value="{{ usuario.user.username|default:'' }}"
                    required
                    {% if usuario %}readonly{% endif %}
                >
            </div>
            
            <div class="form-group">
                <label for="email" class="form-label">Email *</label>
                <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    class="form-control" 
                    value="{{ usuario.user.email|default:'' }}"
                    required
                >
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="first_name" class="form-label">Nombre *</label>
                <input 
                    type="text" 
                    id="first_name" 
                    name="first_name" 
                    class="form-control" 
                    value="{{ usuario.user.first_name|default:'' }}"
                    required
                >
            </div>
            
            <div class="form-group">
                <label for="last_name" class="form-label">Apellido *</label>
                <input 
                    type="text" 
                    id="last_name" 
                    name="last_name" 
                    class="form-control" 
                    value="{{ usuario.user.last_name|default:'' }}"
                    required
                >
            </div>
        </div>
        
        {% if not usuario %}
        <div class="form-row">
            <div class="form-group">
                <label for="password" class="form-label">Contraseña *</label>
                <input 
                    type="password" 
                    id="password" 
                    name="password" 
                    class="form-control"
                    required
                >
            </div>
            
            <div class="form-group">
                <label for="confirm_password" class="form-label">Confirmar Contraseña *</label>
                <input 
                    type="password" 
                    id="confirm_password" 
                    name="confirm_password" 
                    class="form-control"
                    required
                >
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Información del Perfil -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-user-tag"></i> Información del Perfil
            </h3>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="rol" class="form-label">Rol *</label>
                <select id="rol" name="rol" class="form-control" required>
                    <option value="">Seleccionar rol...</option>
                    {% for rol_choice in roles %}
                    <option value="{{ rol_choice.id }}" {% if usuario and usuario.rol.id == rol_choice.id %}selected{% endif %}>
                        {{ rol_choice.get_nombre_display }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="estado" class="form-label">Estado *</label>
                <select id="estado" name="estado" class="form-control" required>
                    <option value="ACTIVO" {% if not usuario or usuario.estado == 'ACTIVO' %}selected{% endif %}>Activo</option>
                    <option value="BLOQUEADO" {% if usuario and usuario.estado == 'BLOQUEADO' %}selected{% endif %}>Bloqueado</option>
                    <option value="INACTIVO" {% if usuario and usuario.estado == 'INACTIVO' %}selected{% endif %}>Inactivo</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="telefono" class="form-label">Teléfono</label>
                <input 
                    type="tel" 
                    id="telefono" 
                    name="telefono" 
                    class="form-control" 
                    value="{{ usuario.telefono|default:'' }}"
                    placeholder="+56 9 1234 5678"
                >
            </div>
            
            <div class="form-group">
                <label for="area_unidad" class="form-label">Área/Unidad</label>
                <input 
                    type="text" 
                    id="area_unidad" 
                    name="area_unidad" 
                    class="form-control" 
                    value="{{ usuario.area_unidad|default:'' }}"
                    placeholder="Ej: Ventas, Bodega, Finanzas"
                >
            </div>
        </div>
        
        <div class="form-group">
            <label for="observaciones" class="form-label">Observaciones</label>
            <textarea 
                id="observaciones" 
                name="observaciones" 
                class="form-control" 
                rows="3"
                placeholder="Información adicional sobre el usuario..."
            >{{ usuario.observaciones|default:'' }}</textarea>
        </div>
    </div>
    
    <!-- Permisos (solo para visualización) -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-shield-alt"></i> Permisos del Rol
            </h3>
        </div>
        <div id="permisos-info" class="permisos-container">
            <p class="text-muted">Selecciona un rol para ver los permisos asignados</p>
        </div>
    </div>
    
    <!-- Botones de Acción -->
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Guardar Usuario
        </button>
        <a href="{% url 'usuarios_list' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</form>

<style>
.user-form .card {
    margin-bottom: 1.5rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
}

.permisos-container {
    padding: 1rem;
}

.permisos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.permiso-item {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 5px;
    border-left: 3px solid var(--color-submenu);
}

.permiso-item i {
    color: var(--color-success);
    margin-right: 0.5rem;
}
</style>

<script>
// Simulación de permisos por rol
const permisosPorRol = {
    'ADMIN': [
        'Acceso completo al sistema',
        'Gestión de usuarios',
        'Gestión de productos',
        'Gestión de inventario',
        'Gestión de compras',
        'Generación de reportes'
    ],
    'VENDEDOR': [
        'Ver productos',
        'Consultar inventario',
        'Registrar ventas',
        'Ver clientes'
    ],
    'BODEGUERO': [
        'Gestión de inventario',
        'Movimientos de productos',
        'Gestión de alertas',
        'Ver productos'
    ],
    'FINANZAS': [
        'Gestión de compras',
        'Gestión de proveedores',
        'Ver reportes financieros',
        'Aprobar órdenes'
    ],
    'JEFE_VENTAS': [
        'Supervisión de ventas',
        'Gestión de productos',
        'Ver inventario',
        'Ver reportes'
    ]
};

document.getElementById('rol')?.addEventListener('change', function() {
    const selectedRol = this.options[this.selectedIndex].text.split(' ').pop();
    const permisosContainer = document.getElementById('permisos-info');
    
    const permisos = Object.keys(permisosPorRol).find(key => 
        selectedRol.includes(key) || key.includes(selectedRol)
    );
    
    if (permisos && permisosPorRol[permisos]) {
        const permisosHTML = permisosPorRol[permisos]
            .map(p => `<div class="permiso-item"><i class="fas fa-check"></i>${p}</div>`)
            .join('');
        
        permisosContainer.innerHTML = `<div class="permisos-grid">${permisosHTML}</div>`;
    } else {
        permisosContainer.innerHTML = '<p class="text-muted">Selecciona un rol para ver los permisos</p>';
    }
});

// Validación de contraseñas
document.querySelector('form')?.addEventListener('submit', function(e) {
    const password = document.getElementById('password');
    const confirmPassword = document.getElementById('confirm_password');
    
    if (password && confirmPassword) {
        if (password.value !== confirmPassword.value) {
            e.preventDefault();
            alert('Las contraseñas no coinciden');
            confirmPassword.focus();
        }
    }
});
</script>
{% endblock %}
